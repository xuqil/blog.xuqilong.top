<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>协程与任务 | FeelingLive</title>
    <meta name="generator" content="VuePress 1.5.4">
    <link rel="icon" href="/assets/img/logo/logo.png">
    <script>
            var _hmt = _hmt || [];
            (function() {
              var hm = document.createElement("script");
              hm.src = "https://hm.baidu.com/hm.js?966c32065299cfcd0ae5ae2eae1aa280";
              var s = document.getElementsByTagName("script")[0]; 
              s.parentNode.insertBefore(hm, s);
            })();            
          </script>
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.57bcb71c.css" as="style"><link rel="preload" href="/assets/js/app.b8069efc.js" as="script"><link rel="preload" href="/assets/js/2.463f0d24.js" as="script"><link rel="preload" href="/assets/js/18.f5401d4b.js" as="script"><link rel="prefetch" href="/assets/js/10.0762cba9.js"><link rel="prefetch" href="/assets/js/11.4708d5da.js"><link rel="prefetch" href="/assets/js/12.c6cafa54.js"><link rel="prefetch" href="/assets/js/13.d8200bdf.js"><link rel="prefetch" href="/assets/js/14.8064c10f.js"><link rel="prefetch" href="/assets/js/15.9243c1a6.js"><link rel="prefetch" href="/assets/js/16.f6f1013c.js"><link rel="prefetch" href="/assets/js/17.fc230ff5.js"><link rel="prefetch" href="/assets/js/19.97ad76e6.js"><link rel="prefetch" href="/assets/js/20.c04d5e36.js"><link rel="prefetch" href="/assets/js/21.3a377e15.js"><link rel="prefetch" href="/assets/js/22.4f0e9918.js"><link rel="prefetch" href="/assets/js/23.8f5b85c7.js"><link rel="prefetch" href="/assets/js/24.e0dea9d9.js"><link rel="prefetch" href="/assets/js/25.6e5a4514.js"><link rel="prefetch" href="/assets/js/26.f1eb71b3.js"><link rel="prefetch" href="/assets/js/27.648fe148.js"><link rel="prefetch" href="/assets/js/28.0f4106c7.js"><link rel="prefetch" href="/assets/js/29.13fab01e.js"><link rel="prefetch" href="/assets/js/3.42c89626.js"><link rel="prefetch" href="/assets/js/30.776c58af.js"><link rel="prefetch" href="/assets/js/31.9d1301f0.js"><link rel="prefetch" href="/assets/js/32.720f8e3c.js"><link rel="prefetch" href="/assets/js/33.3e536bad.js"><link rel="prefetch" href="/assets/js/34.eb929122.js"><link rel="prefetch" href="/assets/js/35.d6c75691.js"><link rel="prefetch" href="/assets/js/36.d1359dcd.js"><link rel="prefetch" href="/assets/js/37.af9dcad6.js"><link rel="prefetch" href="/assets/js/38.4dcdfb0e.js"><link rel="prefetch" href="/assets/js/39.a11a56c7.js"><link rel="prefetch" href="/assets/js/4.32e9b2cd.js"><link rel="prefetch" href="/assets/js/40.99b7368a.js"><link rel="prefetch" href="/assets/js/41.6b4e41f7.js"><link rel="prefetch" href="/assets/js/42.01f4bb4d.js"><link rel="prefetch" href="/assets/js/43.395f4458.js"><link rel="prefetch" href="/assets/js/44.6ffa66fa.js"><link rel="prefetch" href="/assets/js/45.e29df2ce.js"><link rel="prefetch" href="/assets/js/46.72ff2f55.js"><link rel="prefetch" href="/assets/js/47.8ffb0064.js"><link rel="prefetch" href="/assets/js/48.2ca0eabc.js"><link rel="prefetch" href="/assets/js/49.9b2c63ae.js"><link rel="prefetch" href="/assets/js/5.92edf24a.js"><link rel="prefetch" href="/assets/js/50.115e85f5.js"><link rel="prefetch" href="/assets/js/51.8f5cbf89.js"><link rel="prefetch" href="/assets/js/52.4a6fde6e.js"><link rel="prefetch" href="/assets/js/53.b63a6ed6.js"><link rel="prefetch" href="/assets/js/54.fbb07875.js"><link rel="prefetch" href="/assets/js/55.e995daf3.js"><link rel="prefetch" href="/assets/js/56.15951fbe.js"><link rel="prefetch" href="/assets/js/57.4c91e795.js"><link rel="prefetch" href="/assets/js/58.02114ca3.js"><link rel="prefetch" href="/assets/js/6.0b766ead.js"><link rel="prefetch" href="/assets/js/7.beb00bfa.js"><link rel="prefetch" href="/assets/js/8.e469995f.js"><link rel="prefetch" href="/assets/js/9.35927e25.js">
    <link rel="stylesheet" href="/assets/css/0.styles.57bcb71c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/logo/logo.png" alt="FeelingLive" class="logo"> <span class="site-name">FeelingLive</span></a> <nav class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <ul class="nav-links can-hide"><li class="nav-item"><a href="/" class="nav-link"><!----> <span>主页</span></a></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python" class="dropdown-title"><!----> <span class="title">
      Python
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="Python" class="mobile-dropdown-title"><!----> <span class="title">Python</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/python/coroutine/" class="nav-link router-link-active"><!----> <span>协程</span></a></li><li class="dropdown-item"><!----> <a href="/python/advance/" class="nav-link"><!----> <span>进阶</span></a></li><li class="dropdown-item"><!----> <a href="/python/standard/" class="nav-link"><!----> <span>标准库</span></a></li><li class="dropdown-item"><!----> <a href="/python/restFramework/" class="nav-link"><!----> <span>REST Framework</span></a></li><li class="dropdown-item"><!----> <a href="/python/utils/" class="nav-link"><!----> <span>各种工具</span></a></li><li class="dropdown-item"><!----> <a href="/python/skill/" class="nav-link"><!----> <span>使用技巧和例子</span></a></li></ul></div></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><!----> <span class="title">
      Java
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><!----> <span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/basis/" class="nav-link"><!----> <span>基础</span></a></li></ul></div></li><li class="nav-item"><a href="/linux/" class="nav-link"><!----> <span>Linux</span></a></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><!----> <span class="title">
      中间件
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="中间件" class="mobile-dropdown-title"><!----> <span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/middle/elasticsearch/" class="nav-link"><!----> <span>Elasticsearch</span></a></li><li class="dropdown-item"><!----> <a href="/middle/nginx/" class="nav-link"><!----> <span>Nginx</span></a></li><li class="dropdown-item"><!----> <a href="/middle/kafka/" class="nav-link"><!----> <span>Kafka</span></a></li><li class="dropdown-item"><!----> <a href="/middle/f5/" class="nav-link"><!----> <span>F5</span></a></li></ul></div></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><!----> <span class="title">
      数据库
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><!----> <span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/database/mysql/" class="nav-link"><!----> <span>MySQL</span></a></li><li class="dropdown-item"><!----> <a href="/database/redis/" class="nav-link"><!----> <span>Redis</span></a></li></ul></div></li><li class="nav-item"><a href="https://github.com/xuqil" target="_blank" rel="noopener noreferrer" class="nav-link external"><!----> <span>Git Hub</span> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <!----></ul> <div class="theme-switcher"><a class="switch dark"><span><i aria-hidden="true" class="fa fa-moon"></i></span></a></div></nav></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!----> <ul class="nav-links"><li class="nav-item"><a href="/" class="nav-link"><!----> <span>主页</span></a></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Python" class="dropdown-title"><!----> <span class="title">
      Python
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="Python" class="mobile-dropdown-title"><!----> <span class="title">Python</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/python/coroutine/" class="nav-link router-link-active"><!----> <span>协程</span></a></li><li class="dropdown-item"><!----> <a href="/python/advance/" class="nav-link"><!----> <span>进阶</span></a></li><li class="dropdown-item"><!----> <a href="/python/standard/" class="nav-link"><!----> <span>标准库</span></a></li><li class="dropdown-item"><!----> <a href="/python/restFramework/" class="nav-link"><!----> <span>REST Framework</span></a></li><li class="dropdown-item"><!----> <a href="/python/utils/" class="nav-link"><!----> <span>各种工具</span></a></li><li class="dropdown-item"><!----> <a href="/python/skill/" class="nav-link"><!----> <span>使用技巧和例子</span></a></li></ul></div></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><!----> <span class="title">
      Java
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><!----> <span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/basis/" class="nav-link"><!----> <span>基础</span></a></li></ul></div></li><li class="nav-item"><a href="/linux/" class="nav-link"><!----> <span>Linux</span></a></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><!----> <span class="title">
      中间件
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="中间件" class="mobile-dropdown-title"><!----> <span class="title">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/middle/elasticsearch/" class="nav-link"><!----> <span>Elasticsearch</span></a></li><li class="dropdown-item"><!----> <a href="/middle/nginx/" class="nav-link"><!----> <span>Nginx</span></a></li><li class="dropdown-item"><!----> <a href="/middle/kafka/" class="nav-link"><!----> <span>Kafka</span></a></li><li class="dropdown-item"><!----> <a href="/middle/f5/" class="nav-link"><!----> <span>F5</span></a></li></ul></div></li><li class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><!----> <span class="title">
      数据库
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><!----> <span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/database/mysql/" class="nav-link"><!----> <span>MySQL</span></a></li><li class="dropdown-item"><!----> <a href="/database/redis/" class="nav-link"><!----> <span>Redis</span></a></li></ul></div></li><li class="nav-item"><a href="https://github.com/xuqil" target="_blank" rel="noopener noreferrer" class="nav-link external"><!----> <span>Git Hub</span> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <!----></ul>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><i></i> <span>协程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/python/coroutine/" aria-current="page" class="sidebar-link">asyncio --- 异步 I/O</a></li><li><a href="/python/coroutine/协程与任务.html" class="active sidebar-link">协程与任务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#协程" class="sidebar-link">协程</a></li><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#可等待对象" class="sidebar-link">可等待对象</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#协程-2" class="sidebar-link">协程</a></li><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#任务" class="sidebar-link">任务</a></li><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#future-对象" class="sidebar-link">Future 对象</a></li></ul></li><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#运行-asyncio-程序" class="sidebar-link">运行 asyncio 程序</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#asyncio-run" class="sidebar-link">asyncio.run</a></li></ul></li><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#创建任务" class="sidebar-link">创建任务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#asyncio-create-task" class="sidebar-link">asyncio.create_task</a></li></ul></li><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#休眠" class="sidebar-link">休眠</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#asyncio-sleep" class="sidebar-link">asyncio.sleep</a></li></ul></li><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#并发运行任务" class="sidebar-link">并发运行任务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#asyncio-gather" class="sidebar-link">asyncio.gather</a></li></ul></li><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#屏蔽取消操作" class="sidebar-link">屏蔽取消操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#asyncio-shield" class="sidebar-link">asyncio.shield</a></li></ul></li><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#超时" class="sidebar-link">超时</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#asyncio-wait-for" class="sidebar-link">asyncio.wait_for</a></li></ul></li><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#简单等待" class="sidebar-link">简单等待</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#asyncio-wait" class="sidebar-link">asyncio.wait</a></li><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#asyncio-as-completed" class="sidebar-link">asyncio.as_completed</a></li></ul></li><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#在线程中运行" class="sidebar-link">在线程中运行</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#asyncio-to-thread" class="sidebar-link">asyncio.to_thread</a></li></ul></li><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#来自其他线程的调度安排" class="sidebar-link">来自其他线程的调度安排</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#asyncio-run-coroutine-threadsafe" class="sidebar-link">asyncio.run_coroutine_threadsafe</a></li></ul></li><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#内省" class="sidebar-link">内省</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#asyncio-current-task" class="sidebar-link">asyncio.current_task</a></li><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#asyncio-all-tasks" class="sidebar-link">asyncio.all_tasks</a></li></ul></li><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#task-对象" class="sidebar-link">Task 对象</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#asyncio-task" class="sidebar-link">asyncio.Task</a></li></ul></li><li class="sidebar-sub-header"><a href="/python/coroutine/协程与任务.html#基于生成器的协程" class="sidebar-link">基于生成器的协程</a></li></ul></li><li><a href="/python/coroutine/同步原语.html" class="sidebar-link">同步原语</a></li><li><a href="/python/coroutine/异常.html" class="sidebar-link">异常</a></li><li><a href="/python/coroutine/网络IO和IPC.html" class="sidebar-link">streams</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-vpx-content content__default"><h1 id="协程与任务"><a href="#协程与任务" class="header-anchor">#</a> 协程与任务</h1> <p>python的协程使用的是asynio标准库</p> <p>asyncio 是用来编写 <strong>并发</strong> 代码的库，使用 <strong>async/await</strong> 语法。</p> <p>asyncio 被用作多个提供高性能 Python 异步框架的基础，包括网络和网站服务，数据库连接库，分布式任务队列等等。</p> <p>asyncio 往往是构建 IO 密集型和高层级 <strong>结构化</strong> 网络代码的最佳选择。</p> <p>asyncio 提供一组 <strong>高层级</strong> API 用于:</p> <ul><li>并发地 运行 Python 协程并对其执行过程实现完全控制;</li> <li>执行 网络 IO 和 IPC;</li> <li>控制 子进程;</li> <li>通过 队列实现分布式任务;</li> <li>同步 并发代码;</li></ul> <p>此外，还有一些 <strong>低层级</strong> API 以支持 <em>库和框架的开发者</em> 实现:</p> <ul><li>创建和管理 <a href="https://docs.python.org/zh-cn/3/library/asyncio-eventloop.html#asyncio-event-loop" target="_blank" rel="noopener noreferrer">事件循环<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，以提供异步 API 用于 <a href="https://docs.python.org/zh-cn/3/library/asyncio-eventloop.html#asyncio.loop.create_server" target="_blank" rel="noopener noreferrer"><code>网络化</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, 运行 <a href="https://docs.python.org/zh-cn/3/library/asyncio-eventloop.html#asyncio.loop.subprocess_exec" target="_blank" rel="noopener noreferrer"><code>子进程</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，处理 <a href="https://docs.python.org/zh-cn/3/library/asyncio-eventloop.html#asyncio.loop.add_signal_handler" target="_blank" rel="noopener noreferrer"><code>OS 信号</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 等等;</li> <li>使用 <a href="https://docs.python.org/zh-cn/3/library/asyncio-protocol.html#asyncio-transports-protocols" target="_blank" rel="noopener noreferrer">transports<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 实现高效率协议;</li> <li>通过 async/await 语法 <a href="https://docs.python.org/zh-cn/3/library/asyncio-future.html#asyncio-futures" target="_blank" rel="noopener noreferrer">桥接<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 基于回调的库和代码。</li></ul> <h2 id="协程"><a href="#协程" class="header-anchor">#</a> 协程</h2> <p>协程 通过 async/await 语法进行声明，是编写 asyncio 应用的推荐方式。 例如，以下代码段（需要 Python 3.7+）会打印 &quot;hello&quot;，等待 1 秒，再打印 &quot;world&quot;:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">import</span> asyncio

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'world'</span><span class="token punctuation">)</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
hello
world
</code></pre></div><p>注意：简单地调用一个协程并不会将其加入执行任务:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> main<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>coroutine <span class="token builtin">object</span> main at <span class="token number">0x000001DD2975E140</span><span class="token operator">&gt;</span>
</code></pre></div><p>要真正运行一个协程，asyncio 提供了三种主要机制:</p> <ul><li><p><code>asyncio.run()</code> 函数用来运行最高层级的入口点 &quot;main()&quot; 函数 (参见上面的示例。)</p></li> <li><p>等待一个协程。以下代码段会在等待 1 秒后打印 &quot;hello&quot;，然后 <em>再次</em> 等待 2 秒后打印 &quot;world&quot;:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> time
<span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">say_after</span><span class="token punctuation">(</span>delay<span class="token punctuation">,</span> what<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>delay<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>what<span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;started at </span><span class="token interpolation"><span class="token punctuation">{</span>time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%X'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>

    <span class="token keyword">await</span> say_after<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'hello'</span><span class="token punctuation">)</span>  <span class="token comment"># 先执行</span>
    <span class="token keyword">await</span> say_after<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'world'</span><span class="token punctuation">)</span>  <span class="token comment"># 再执行</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;finished at </span><span class="token interpolation"><span class="token punctuation">{</span>time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%X'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>预期的输出:</p> <div class="language-python extra-class"><pre class="language-python"><code>started at <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">07</span><span class="token punctuation">:</span><span class="token number">39</span>
hello
world
finished at <span class="token number">23</span><span class="token punctuation">:</span><span class="token number">07</span><span class="token punctuation">:</span><span class="token number">42</span>
</code></pre></div></li> <li><p><code>asyncio.create_task()</code> 函数用来并发运行作为 asyncio <code>任务</code>的多个协程。</p> <p>让我们修改以上示例，<em>并发</em> 运行两个 <code>say_after</code> 协程:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    task1 <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>
        say_after<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    task2 <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>
        say_after<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'world'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;started at </span><span class="token interpolation"><span class="token punctuation">{</span>time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%X'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>

    <span class="token comment"># task1和task2同时执行，实现并发；一共用了2秒，因为时间最长的任务task2是2秒</span>
    <span class="token keyword">await</span> task1
    <span class="token keyword">await</span> task2

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;finished at </span><span class="token interpolation"><span class="token punctuation">{</span>time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%X'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
</code></pre></div></li></ul> <h2 id="可等待对象"><a href="#可等待对象" class="header-anchor">#</a> 可等待对象</h2> <p>如果一个对象可以在 <code>await</code> 语句中使用，那么它就是 <strong>可等待</strong> 对象。许多 asyncio API 都被设计为接受可等待对象。</p> <p><em>可等待</em> 对象有三种主要类型: <strong>协程</strong>, <strong>任务</strong> 和 <strong>Future</strong>.</p> <h3 id="协程-2"><a href="#协程-2" class="header-anchor">#</a> 协程</h3> <p>Python 协程属于 <em>可等待</em> 对象，因此可以在其他协程中被等待:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">nested</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token number">42</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Nothing happens if we just call &quot;nested()&quot;.</span>
    <span class="token comment"># A coroutine object is created but not awaited,</span>
    <span class="token comment"># so it *won't run at all*.</span>
    nested<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Let's do it differently now and await it:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token keyword">await</span> nested<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># will print &quot;42&quot;.</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>重要</strong>：在本文档中 &quot;协程&quot; 可用来表示两个紧密关联的概念:</p> <ul><li><em>协程函数</em>: 定义形式为 <code>async def</code> 的函数;</li> <li><em>协程对象</em>: 调用 <em>协程函数</em> 所返回的对象。</li></ul> <p>asyncio 也支持旧式的 <code>基于生成器的</code>协程。</p> <h3 id="任务"><a href="#任务" class="header-anchor">#</a> 任务</h3> <p><em>任务</em> 被用来设置调度以便 <em>并发</em> 执行协程。</p> <p>当一个协程通过 <code>asyncio.create_task()</code>等函数被打包为一个 <em>任务</em>，该协程将自动排入日程准备立即运行:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">nested</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token number">42</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 使用create_task将nested()创建为一个任务，可以使用main函数执行</span>
    task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>nested<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># task可以取消，或者等待执行完毕</span>
    <span class="token keyword">await</span> task 
    <span class="token comment">#print(await task)   42</span>
    <span class="token comment">#print(task.cancel())  False</span>
    <span class="token comment">#print(task.done())   True</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="future-对象"><a href="#future-对象" class="header-anchor">#</a> Future 对象</h3> <p><code>Future</code> 是一种特殊的 <strong>低层级</strong> 可等待对象，表示一个异步操作的 <strong>最终结果</strong>。</p> <ul><li><p>当一个 Future 对象 <em>被等待</em>，这意味着协程将保持等待直到该 Future 对象在其他地方操作完毕。</p></li> <li><p>在 asyncio 中需要 Future 对象以便允许通过 async/await 使用基于回调的代码。</p></li> <li><p>通常情况下 <strong>没有必要</strong> 在应用层级的代码中创建 Future 对象。</p></li></ul> <p>Future 对象有时会由库和某些 asyncio API 暴露给用户，用作可等待对象:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> function_that_returns_a_future_object<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># this is also valid:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>
        function_that_returns_a_future_object<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        some_python_coroutine<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
</code></pre></div><p>一个很好的返回对象的低层级函数的示例是 <a href="https://docs.python.org/zh-cn/3/library/asyncio-eventloop.html#asyncio.loop.run_in_executor" target="_blank" rel="noopener noreferrer"><code>loop.run_in_executor()</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h2 id="运行-asyncio-程序"><a href="#运行-asyncio-程序" class="header-anchor">#</a> 运行 asyncio 程序</h2> <h3 id="asyncio-run"><a href="#asyncio-run" class="header-anchor">#</a> <code>asyncio.run</code></h3> <p><code>asyncio.run(coro, *, debug=False)</code></p> <ul><li><p>执行 <code>coroutine</code>（<strong>协程</strong>）<em>coro</em>函数 并返回结果。</p></li> <li><p>此函数会运行传入的协程，负责管理 asyncio 事件循环，<em>终结异步生成器</em>，并关闭线程池。</p></li> <li><p>当有其他 asyncio 事件循环在同一线程中运行时，此函数不能被调用。</p></li> <li><p>如果 <em>debug</em> 为 <code>True</code>，事件循环将以调试模式运行。</p></li> <li><p>此函数总是会创建一个新的事件循环并在结束时关闭之。它应当被用作 <strong>asyncio 程序的主入口点，理想情况下应当只被调用一次</strong>。</p></li></ul> <p>示例:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="创建任务"><a href="#创建任务" class="header-anchor">#</a> 创建任务</h2> <h3 id="asyncio-create-task"><a href="#asyncio-create-task" class="header-anchor">#</a> <code>asyncio.create_task</code></h3> <p><code>asyncio.create_task(coro, *, name=None)</code></p> <ul><li><p>将 <em>coro</em> 协程打包为一个 <a href="https://docs.python.org/zh-cn/3/library/asyncio-task.html#asyncio.Task" target="_blank" rel="noopener noreferrer"><code>Task</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 排入日程准备执行。返回 Task 对象。</p></li> <li><p><em>name</em> 不为 <code>None</code>，它将使用 <a href="https://docs.python.org/zh-cn/3/library/asyncio-task.html#asyncio.Task.set_name" target="_blank" rel="noopener noreferrer"><code>Task.set_name()</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 来设为任务的名称。</p></li> <li><p>该任务会在 <a href="https://docs.python.org/zh-cn/3/library/asyncio-eventloop.html#asyncio.get_running_loop" target="_blank" rel="noopener noreferrer"><code>get_running_loop()</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 返回的循环中执行，如果当前线程没有在运行的循环则会引发 <a href="https://docs.python.org/zh-cn/3/library/exceptions.html#RuntimeError" target="_blank" rel="noopener noreferrer"><code>RuntimeError</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p></li></ul> <p>此函数 <strong>在 Python 3.7 中被加入</strong>。在 Python 3.7 之前，可以改用低层级的 <a href="https://docs.python.org/zh-cn/3/library/asyncio-future.html#asyncio.ensure_future" target="_blank" rel="noopener noreferrer"><code>asyncio.ensure_future()</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 函数。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">coro</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment"># In Python 3.7+</span>
task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>coro<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment"># This works in all Python versions but is less readable</span>
task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>ensure_future<span class="token punctuation">(</span>coro<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p><em>3.7 新版功能.</em></p> <p><em>在 3.8 版更改:</em> 添加了 <code>name</code> 形参。</p> <h2 id="休眠"><a href="#休眠" class="header-anchor">#</a> 休眠</h2> <h3 id="asyncio-sleep"><a href="#asyncio-sleep" class="header-anchor">#</a> <code>asyncio.sleep</code></h3> <p><code>coroutine asyncio.sleep(delay, result=None, *, loop=None)</code></p> <ul><li><p>阻塞 <em>delay</em> 指定的秒数。</p></li> <li><p>如果指定了 <em>result</em>，则当协程完成时将其返回给调用者。</p></li> <li><p><code>sleep()</code> 总是会挂起当前任务，以允许其他任务运行。</p></li></ul> <p>以下协程示例运行 5 秒，每秒显示一次当前日期:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> datetime

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">display_date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    end_time <span class="token operator">=</span> loop<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">5.0</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loop<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> end_time<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 休眠1s</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>display_date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="并发运行任务"><a href="#并发运行任务" class="header-anchor">#</a> 并发运行任务</h2> <h3 id="asyncio-gather"><a href="#asyncio-gather" class="header-anchor">#</a> <code>asyncio.gather</code></h3> <p><code>awaitable asyncio.gather(*aws, loop=None, return_exceptions=False)</code></p> <ul><li><p>aws为一个或多个协程对象</p></li> <li><p><em>并发</em> 运行 <em>aws</em> 序列中的 <em>可等待对象</em>。</p></li> <li><p><em>aws</em> 中的可等待对象为协程，自动作为一个任务加入调度。</p></li> <li><p>如果所有可等待对象都成功完成，结果将是一个由所有返回值聚合而成的列表。结果值的顺序与 <em>aws</em> 中可等待对象的顺序一致。</p></li> <li><p>如果 <em>return_exceptions</em> 为 <code>False</code> (默认)，所引发的首个异常会立即传播给等待 <code>gather()</code> 的任务。<em>aws</em> 序列中的其他可等待对象 <strong>不会被取消</strong> 并将继续运行。</p></li> <li><p>如果 <em>return_exceptions</em> 为 <code>False</code> (默认)，当aws中某个任务抛出异常时，会影响其他没有完成的任务，会直接终止任务的执行。</p></li> <li><p>如果 <em>return_exceptions</em> 为 <code>True</code>，异常会和成功的结果一样处理，并聚合至结果列表。</p></li> <li><p>如果 <code>gather()</code> <em>被取消</em>，所有被提交 (尚未完成) 的可等待对象也会 <em>被取消</em>。</p></li> <li><p>如果 <em>aws</em> 序列中的任一 Task 或 Future 对象 <em>被取消</em>，它将被当作引发了 <a href="https://docs.python.org/zh-cn/3/library/asyncio-exceptions.html#asyncio.CancelledError" target="_blank" rel="noopener noreferrer"><code>CancelledError</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 一样处理 -- 在此情况下 <code>gather()</code> 调用 <strong>不会</strong> 被取消。这是为了防止一个已提交的 Task/Future 被取消导致其他 Tasks/Future 也被取消。</p></li></ul> <p>示例：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">factorial</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">:</span>
    f <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Task </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">: Compute factorial(</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">)...&quot;</span></span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        f <span class="token operator">*=</span> i
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Task </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">: factorial(</span><span class="token interpolation"><span class="token punctuation">{</span>number<span class="token punctuation">}</span></span><span class="token string">) = </span><span class="token interpolation"><span class="token punctuation">{</span>f<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 调度了三个任务</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>
        factorial<span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        factorial<span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        factorial<span class="token punctuation">(</span><span class="token string">'C'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># Expected output:</span>
<span class="token comment">#</span>
<span class="token comment"># Task A: factorial(1) = 1</span>
<span class="token comment"># Task B: Compute factorial(2)...</span>
<span class="token comment"># Task C: Compute factorial(2)...</span>
<span class="token comment"># Task B: factorial(2) = 2</span>
<span class="token comment"># Task C: Compute factorial(3)...</span>
<span class="token comment"># Task C: factorial(3) = 6</span>
</code></pre></div><blockquote><p>注意：如果 <em>return_exceptions</em> 为 False，则在 gather() 被标记为已完成后取消它将不会取消任何已提交的可等待对象。 例如，在将一个异常传播给调用者之后，gather 可被标记为已完成，因此，在从 gather 捕获一个（由可等待对象所引发的）异常之后调用 <code>gather.cancel()</code> 将不会取消任何其他可等待对象。</p></blockquote> <ul><li><p><code>return_exceptions =False</code>：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">factorial</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">:</span>
    f <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Task </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">: Compute factorial(</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">)...&quot;</span></span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        f <span class="token operator">*=</span> i
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Task </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">: factorial(</span><span class="token interpolation"><span class="token punctuation">{</span>number<span class="token punctuation">}</span></span><span class="token string">) = </span><span class="token interpolation"><span class="token punctuation">{</span>f<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">factorial2</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">:</span>
    task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>demo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    task<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> task  <span class="token comment"># task取消了，发生异常</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Task </span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">: factorial(</span><span class="token interpolation"><span class="token punctuation">{</span>number<span class="token punctuation">}</span></span><span class="token string">)&quot;</span></span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> <span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 调度了三个任务</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>
            factorial<span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            factorial<span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            factorial<span class="token punctuation">(</span><span class="token string">'C'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            factorial2<span class="token punctuation">(</span><span class="token string">'D'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            return_exceptions<span class="token operator">=</span><span class="token boolean">False</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> asyncio<span class="token punctuation">.</span>CancelledError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 没有执行完成的所有的任务都被停止执行</span>
<span class="token comment"># Expected output:</span>
<span class="token comment">#</span>
<span class="token comment"># Task A: factorial(1) = 1</span>
<span class="token comment"># Task B: Compute factorial(2)...</span>
<span class="token comment"># Task C: Compute factorial(2)...</span>
</code></pre></div></li> <li><p><code>return_exceptions =True</code>：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 调度了三个任务</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>
            factorial<span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            factorial<span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            factorial<span class="token punctuation">(</span><span class="token string">'C'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            factorial2<span class="token punctuation">(</span><span class="token string">'D'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            return_exceptions<span class="token operator">=</span><span class="token boolean">True</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> asyncio<span class="token punctuation">.</span>CancelledError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>


asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 不会影响其他任务，没有执行完成的所有的任务会继续执行下去</span>
<span class="token comment"># 错误处理返回在任务结果列表里</span>
<span class="token comment"># Expected output:</span>
<span class="token comment">#</span>
<span class="token comment"># Task A: factorial(1) = 1</span>
<span class="token comment"># Task B: Compute factorial(2)...</span>
<span class="token comment"># Task C: Compute factorial(2)...</span>
<span class="token comment"># Task B: factorial(2) = 2</span>
<span class="token comment"># Task C: Compute factorial(3)...</span>
<span class="token comment"># Task C: factorial(3) = 6</span>
<span class="token comment"># [None, None, None, CancelledError()]</span>
</code></pre></div></li></ul> <p>在 3.7 版更改: 如果 gather 本身被取消，则无论 return_exceptions 取值为何，消息都会被传播。</p> <h2 id="屏蔽取消操作"><a href="#屏蔽取消操作" class="header-anchor">#</a> 屏蔽取消操作</h2> <h3 id="asyncio-shield"><a href="#asyncio-shield" class="header-anchor">#</a> <code>asyncio.shield</code></h3> <p><code>awaitable asyncio.shield(aw, *, loop=None)</code></p> <ul><li><p>保护一个 <em>可等待对象</em> 防止其被 <strong>取消</strong>。</p></li> <li><p><em>aw</em> 是一个协程，作为任务加入调度。</p></li></ul> <p>以下语句:</p> <div class="language-python extra-class"><pre class="language-python"><code>res <span class="token operator">=</span> <span class="token keyword">await</span> shield<span class="token punctuation">(</span>something<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>相当于:</p> <div class="language-python extra-class"><pre class="language-python"><code>res <span class="token operator">=</span> <span class="token keyword">await</span> something<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><em>不同之处</em> 在于如果包含它的协程被取消，在 <code>something()</code> 中运行的任务不会被取消。从 <code>something()</code> 的角度看来，取消操作并没有发生。然而其调用者已被取消，因此 &quot;await&quot; 表达式仍然会引发 <code>CancelledError</code>。</p> <p>如果通过其他方式取消 <code>something()</code> (例如在其内部操作) 则 <code>shield()</code> 也会取消。</p> <p>如果希望完全忽略取消操作 (不推荐) 则 <code>shield()</code> 函数需要配合一个 try/except 代码段，如下所示:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">try</span><span class="token punctuation">:</span>
    res <span class="token operator">=</span> <span class="token keyword">await</span> shield<span class="token punctuation">(</span>something<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> asyncio<span class="token punctuation">.</span>CancelledError<span class="token punctuation">:</span>
    res <span class="token operator">=</span> <span class="token boolean">None</span>
</code></pre></div><blockquote><p><code>shield</code> 似乎没什么效果，并不能屏蔽取消操作</p></blockquote> <h2 id="超时"><a href="#超时" class="header-anchor">#</a> 超时</h2> <h3 id="asyncio-wait-for"><a href="#asyncio-wait-for" class="header-anchor">#</a> <code>asyncio.wait_for</code></h3> <p><code>coroutine asyncio.wait_for(aw, timeout, *, loop=None)</code></p> <ul><li><p>等待 <em>aw</em> 可等待对象完成，指定 timeout 秒数后超时。</p></li> <li><p><em>aw</em> 是一个协程，自动作为任务加入调度。</p></li> <li><p><em>timeout</em> 可以为 <code>None</code>，也可以为 float 或 int 型数值表示的等待秒数。如果 <em>timeout</em> 为 <code>None</code>，则等待直到完成。</p></li> <li><p>如果发生超时，任务将取消并引发 <code>asyncio.TimeoutError</code>。</p></li> <li><p>要避免任务取消，可以加上 <code>shield()</code>。</p></li> <li><p>此函数将等待直到 Future 确实被取消，所以总等待时间可能超过 <em>timeout</em>。 如果在取消期间发生了异常，异常将会被传播。</p></li> <li><p>如果等待被取消，则 <em>aw</em> 指定的对象也会被取消。</p></li></ul> <p>示例:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">eternity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Sleep for one hour</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3600</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'yay!'</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Wait for at most 1 second</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>wait_for<span class="token punctuation">(</span>eternity<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> asyncio<span class="token punctuation">.</span>TimeoutError<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'timeout!'</span><span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># Expected output:</span>
<span class="token comment">#</span>
<span class="token comment">#     timeout!</span>
</code></pre></div><p>在 3.7 版更改: 当 aw 因超时被取消，wait_for 会等待 aw 被取消。之前版本则将立即引发<code>asyncio.TimeoutError</code>。</p> <blockquote><p><strong>注意</strong>：等待<code>create_task</code>创建的任务超时，调用<code>done()</code>获取的结果为True，令人迷惑</p></blockquote> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> asyncio
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">eternity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Sleep for one hour</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3600</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'yay!'</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Wait for at most 1 second</span>
    task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>eternity<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>wait_for<span class="token punctuation">(</span>task<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> asyncio<span class="token punctuation">.</span>TimeoutError<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'timeout!'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>cancelled<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>done<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># Expected output:</span>
<span class="token comment">#</span>
<span class="token comment">#	timeout!</span>
<span class="token comment">#	True</span>
<span class="token comment">#	True</span>
</code></pre></div><h2 id="简单等待"><a href="#简单等待" class="header-anchor">#</a> 简单等待</h2> <h3 id="asyncio-wait"><a href="#asyncio-wait" class="header-anchor">#</a> <code>asyncio.wait</code></h3> <p><code>coroutine asyncio.wait(aws, *, loop=None, timeout=None, return_when=ALL_COMPLETED)</code></p> <ul><li><p>并发运行 <em>aws</em> 指定的 可等待对象并阻塞线程直到满足<code>*return_when*</code>指定的条件。</p></li> <li><p><em>aws</em> 集必须不为空。</p></li> <li><p>返回两个 Task/Future 集合: <code>(done, pending)</code>。</p></li> <li><p>指定 <em>timeout</em> (float 或 int 类型) 则它将被用于控制返回之前等待的最长秒数。</p> <ul><li>请注意此函数不会引发 <code>asyncio.TimeoutError</code>。当超时发生时，未完成的 Future 或 Task 将在指定秒数后被返回。</li></ul></li></ul> <p>用法:</p> <div class="language-python extra-class"><pre class="language-python"><code>done<span class="token punctuation">,</span> pending <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>aws<span class="token punctuation">)</span>
</code></pre></div><p><em>return_when</em> 指定此函数应在何时返回。它必须为以下常数之一:</p> <table><thead><tr><th style="text-align:left;">常数</th> <th style="text-align:left;">描述</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>FIRST_COMPLETED</code></td> <td style="text-align:left;">函数将在任意可等待对象结束或取消时返回。</td></tr> <tr><td style="text-align:left;"><code>FIRST_EXCEPTION</code></td> <td style="text-align:left;">函数将在任意可等待对象因引发异常而结束时返回。当没有引发任何异常时它就相当于 <code>ALL_COMPLETED</code>。</td></tr> <tr><td style="text-align:left;"><code>ALL_COMPLETED</code></td> <td style="text-align:left;">函数将在所有可等待对象结束或取消时返回。</td></tr></tbody></table> <p>与 <code>wait_for()</code>不同，<code>wait()</code> 在超时发生时不会取消可等待对象。</p> <blockquote><p><em>3.8 版后已移除:</em> 如果 <em>aws</em> 中的某个可等待对象为协程，它将自动作为任务加入调度。直接向 <code>wait()</code> 传入协程对象已弃用，因为这会导致 令人迷惑的行为。</p></blockquote> <ul><li><p>示例</p> <p><strong>注意：</strong><code>wait()</code> 会自动将协程作为任务加入调度，以后将以 <code>(done, pending)</code> 集合形式返回显式创建的任务对象。因此以下代码并不会有预期的行为:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token number">42</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    coro <span class="token operator">=</span> foo<span class="token punctuation">(</span><span class="token punctuation">)</span>
    done<span class="token punctuation">,</span> pending <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">{</span>coro<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> coro <span class="token keyword">in</span> done<span class="token punctuation">:</span>
        <span class="token comment"># 跟预期的不一样，core不会在done集合里面</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> task <span class="token keyword">in</span> done<span class="token punctuation">:</span>
        <span class="token comment"># 但是可以获取任务结果，说明任务执行完毕</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
<span class="token comment"># Expected output:</span>
<span class="token comment">#</span>
<span class="token comment">#  42</span>
</code></pre></div><p>以上代码段的修正方法如下:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token number">42</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>foo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    done<span class="token punctuation">,</span> pending <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">{</span>task<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> task <span class="token keyword">in</span> done<span class="token punctuation">:</span>
        <span class="token comment"># 跟预期的一样</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span> 
    <span class="token keyword">for</span> task <span class="token keyword">in</span> done<span class="token punctuation">:</span>
        <span class="token comment"># 但是可以获取任务结果，说明任务执行完毕</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
<span class="token comment"># Expected output:</span>
<span class="token comment">#</span>
<span class="token comment">#  ok</span>
<span class="token comment">#  42</span>
</code></pre></div></li> <li><p>超时设置（timeout）</p> <blockquote><p><strong>注意</strong>：与<code>wait_for()</code>相反，任务超时后，调用<code>done()</code>获取的结果为<code>False</code>，任务并没有被取消，也没有执行完成</p></blockquote> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3600</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">42</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>foo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    task<span class="token punctuation">.</span>set_name<span class="token punctuation">(</span><span class="token string">'Task-foo1'</span><span class="token punctuation">)</span>
    done<span class="token punctuation">,</span> pending <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">{</span>task<span class="token punctuation">}</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> task <span class="token keyword">in</span> pending<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>task<span class="token punctuation">.</span>get_name<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> [cancelled] </span><span class="token interpolation"><span class="token punctuation">{</span>task<span class="token punctuation">.</span>cancelled<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>task<span class="token punctuation">.</span>get_name<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> [done] </span><span class="token interpolation"><span class="token punctuation">{</span>task<span class="token punctuation">.</span>done<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

    task2 <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>foo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    task2<span class="token punctuation">.</span>set_name<span class="token punctuation">(</span><span class="token string">'Task-foo2'</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>wait_for<span class="token punctuation">(</span>task2<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> asyncio<span class="token punctuation">.</span>TimeoutError<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>task2<span class="token punctuation">.</span>get_name<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> timeout'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>task2<span class="token punctuation">.</span>get_name<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> [cancelled] </span><span class="token interpolation"><span class="token punctuation">{</span>task2<span class="token punctuation">.</span>cancelled<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>task2<span class="token punctuation">.</span>get_name<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> [done] </span><span class="token interpolation"><span class="token punctuation">{</span>task2<span class="token punctuation">.</span>done<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token comment"># Expected output:</span>
<span class="token comment">#</span>
<span class="token comment"># Task-foo1 [cancelled] False</span>
<span class="token comment"># Task-foo1 [done] False</span>
<span class="token comment"># Task-foo2 timeout</span>
<span class="token comment"># Task-foo2 [cancelled] True</span>
<span class="token comment"># Task-foo2 [done] True</span>
</code></pre></div></li> <li><p>指定参数<code>return_when</code></p> <ul><li><p><code>return_when</code>默认值为<code>ALL_COMPLETED</code>，当所有任务执行完毕后才会返回。</p></li> <li><p><code>return_when</code>为<code>FIRST_COMPLETED</code>时，函数将在任意任务结束或取消时返回，其他未完成的任务会被取消。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token number">42</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3600</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">10</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    task1 <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>foo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    task2 <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>bar<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    done<span class="token punctuation">,</span> pending <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">{</span>task1<span class="token punctuation">,</span> task2<span class="token punctuation">}</span><span class="token punctuation">,</span> return_when<span class="token operator">=</span>asyncio<span class="token punctuation">.</span>FIRST_COMPLETED<span class="token punctuation">)</span>
    <span class="token keyword">if</span> task1 <span class="token keyword">in</span> done<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'[done] </span><span class="token interpolation"><span class="token punctuation">{</span>task1<span class="token punctuation">.</span>done<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'[result] </span><span class="token interpolation"><span class="token punctuation">{</span>task1<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> task2 <span class="token keyword">in</span> pending<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'[cancel] </span><span class="token interpolation"><span class="token punctuation">{</span>task2<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        
asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># Expected output:</span>
<span class="token comment">#</span>
<span class="token comment"># [done] True</span>
<span class="token comment"># [result] 42</span>
<span class="token comment"># [cancel] True</span>
</code></pre></div></li> <li><p><code>return_when</code>为<code>FIRST_COMPLETED</code>时，函数将在任意任务因引发异常而结束时返回。当没有引发任何异常时它就相当于 <code>ALL_COMPLETED</code>。</p></li></ul></li></ul> <h3 id="asyncio-as-completed"><a href="#asyncio-as-completed" class="header-anchor">#</a> <code>asyncio.as_completed</code></h3> <p><code>asyncio.as_completed(aws, *, loop=None, timeout=None)</code></p> <ul><li><p>并发地运行 <em>aws</em> 集合中的 可等待对象。 返回一个协程的迭代器。 所返回的每个协程可被等待以从剩余的可等待对象集合中获得最早的下一个结果。</p></li> <li><p>如果在所有 Future 对象完成前发生超时则将引发 <code>asyncio.TimeoutError</code>。</p></li></ul> <p>示例：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token number">42</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    task1 <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>foo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># for core in asyncio.as_completed({task1}):</span>
    <span class="token keyword">for</span> core <span class="token keyword">in</span> asyncio<span class="token punctuation">.</span>as_completed<span class="token punctuation">(</span><span class="token punctuation">{</span>foo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        result <span class="token operator">=</span> <span class="token keyword">await</span> core
        <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre></div><h2 id="在线程中运行"><a href="#在线程中运行" class="header-anchor">#</a> 在线程中运行</h2> <h3 id="asyncio-to-thread"><a href="#asyncio-to-thread" class="header-anchor">#</a> <code>asyncio.to_thread</code></h3> <p><code>coroutine asyncio.to_thread(func, /, *args, **kwargs)</code></p> <ul><li><p>在不同的线程中异步地运行函数 <em>func</em>。</p></li> <li><p>向此函数提供的任何 *args 和 **kwargs 会被直接传给 <em>func</em>。 并且，当前 <a href="https://docs.python.org/zh-cn/3/library/contextvars.html#contextvars.Context" target="_blank" rel="noopener noreferrer"><code>contextvars.Context</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 会被传播，允许在不同的线程中访问- 来自事件循环的上下文变量。</p></li> <li><p>返回一个可被等待以获取 <em>func</em> 的最终结果的协程。</p></li></ul> <p>这个协程函数主要是用于执行在其他情况下会阻塞事件循环的 IO 密集型函数/方法。 例如:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">blocking_io</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;start blocking_io at </span><span class="token interpolation"><span class="token punctuation">{</span>time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%X'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
    <span class="token comment"># Note that time.sleep() can be replaced with any blocking</span>
    <span class="token comment"># IO-bound operation, such as file operations.</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;blocking_io complete at </span><span class="token interpolation"><span class="token punctuation">{</span>time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%X'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;started main at </span><span class="token interpolation"><span class="token punctuation">{</span>time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%X'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>

    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>
        asyncio<span class="token punctuation">.</span>to_thread<span class="token punctuation">(</span>blocking_io<span class="token punctuation">)</span><span class="token punctuation">,</span>
        asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;finished main at </span><span class="token interpolation"><span class="token punctuation">{</span>time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%X'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>


asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># Expected output:</span>
<span class="token comment">#</span>
<span class="token comment"># started main at 19:50:53</span>
<span class="token comment"># start blocking_io at 19:50:53</span>
<span class="token comment"># blocking_io complete at 19:50:54</span>
<span class="token comment"># finished main at 19:50:54</span>
</code></pre></div><p>在任何协程中直接调用<code>blocking_io()</code>将会在调用期间阻塞事件循环，导致额外的 1 秒运行时间。 而通过改用<code>asyncio.to_thread()</code>，我们可以在不同的线程中运行它从而不会阻塞事件循环。</p> <blockquote><p>**注意：**由于 <a href="https://docs.python.org/zh-cn/3/glossary.html#term-gil" target="_blank" rel="noopener noreferrer">GIL<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的存在，asyncio.to_thread() 通常只能被用来将 IO 密集型函数变为非阻塞的。 但是，对于会释放 GIL 的扩展模块或无此限制的替代性 Python 实现来说，asyncio.to_thread() 也可被用于 CPU 密集型函数。</p></blockquote> <p>3.9 新版功能</p> <h2 id="来自其他线程的调度安排"><a href="#来自其他线程的调度安排" class="header-anchor">#</a> 来自其他线程的调度安排</h2> <h3 id="asyncio-run-coroutine-threadsafe"><a href="#asyncio-run-coroutine-threadsafe" class="header-anchor">#</a> <code>asyncio.run_coroutine_threadsafe</code></h3> <p><code>asyncio.run_coroutine_threadsafe(coro, loop)</code></p> <ul><li><p>向指定事件循环提交一个协程。线程安全。</p></li> <li><p>返回一个 <a href="https://docs.python.org/zh-cn/3/library/concurrent.futures.html#concurrent.futures.Future" target="_blank" rel="noopener noreferrer"><code>concurrent.futures.Future</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 以等待来自其他 OS 线程的结果。</p></li></ul> <p>此函数应该从另一个 OS 线程中调用，而非事件循环运行所在线程。示例:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># Create a coroutine</span>
coro <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> result<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>

<span class="token comment"># Submit the coroutine to a given loop</span>
future <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>run_coroutine_threadsafe<span class="token punctuation">(</span>coro<span class="token punctuation">,</span> loop<span class="token punctuation">)</span>

<span class="token comment"># Wait for the result with an optional timeout argument</span>
<span class="token keyword">assert</span> future<span class="token punctuation">.</span>result<span class="token punctuation">(</span>timeout<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span>
</code></pre></div><p>如果在协程内产生了异常，将会通知返回的 Future 对象。它也可被用来取消事件循环中的任务:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">try</span><span class="token punctuation">:</span>
    result <span class="token operator">=</span> future<span class="token punctuation">.</span>result<span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>
<span class="token keyword">except</span> asyncio<span class="token punctuation">.</span>TimeoutError<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'The coroutine took too long, cancelling the task...'</span><span class="token punctuation">)</span>
    future<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> Exception <span class="token keyword">as</span> exc<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'The coroutine raised an exception: </span><span class="token interpolation"><span class="token punctuation">{</span>exc<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'The coroutine returned: </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
</code></pre></div><p>不同与其他 asyncio 函数，此函数要求显式地传入 <em>loop</em> 参数。</p> <p>3.5.1 新版功能.</p> <h2 id="内省"><a href="#内省" class="header-anchor">#</a> 内省</h2> <h3 id="asyncio-current-task"><a href="#asyncio-current-task" class="header-anchor">#</a> <code>asyncio.current_task</code></h3> <p><code>asyncio.current_task(loop=None)</code></p> <ul><li><p>返回当前运行的 <code>Task</code> 实例，如果没有正在运行的任务则返回 <code>None</code>。</p></li> <li><p>如果 <em>loop</em> 为 <code>None</code> 则会使用 <a href="https://docs.python.org/zh-cn/3/library/asyncio-eventloop.html#asyncio.get_running_loop" target="_blank" rel="noopener noreferrer"><code>get_running_loop()</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 获取当前事件循环。</p></li></ul> <p><em>3.7 新版功能.</em></p> <h3 id="asyncio-all-tasks"><a href="#asyncio-all-tasks" class="header-anchor">#</a> <code>asyncio.all_tasks</code></h3> <p><code>asyncio.all_tasks(loop=None)</code></p> <p>返回事件循环所运行的未完成的 <code>Task</code> 对象的集合。</p> <p>如果 <em>loop</em> 为 <code>None</code>，则会使用 <code>get_running_loop()</code>获取当前事件循环。</p> <p><em>3.7 新版功能.</em></p> <p>示例：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> asyncio

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">42</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">42</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>foo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    task<span class="token punctuation">.</span>set_name<span class="token punctuation">(</span><span class="token string">'Task-foo'</span><span class="token punctuation">)</span>
    task2 <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>bar<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    task2<span class="token punctuation">.</span>set_name<span class="token punctuation">(</span><span class="token string">'Task-bar'</span><span class="token punctuation">)</span>
    loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    running_loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>all_tasks<span class="token punctuation">(</span>loop<span class="token punctuation">)</span>
    <span class="token keyword">for</span> task <span class="token keyword">in</span> running_loop<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>task<span class="token punctuation">.</span>get_name<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">  </span><span class="token interpolation"><span class="token punctuation">{</span>task<span class="token punctuation">.</span>done<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>


asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token comment"># Expected output:</span>
<span class="token comment"># </span>
<span class="token comment"># ok</span>
<span class="token comment"># ok</span>
<span class="token comment"># Task-1</span>
<span class="token comment"># False</span>
</code></pre></div><h2 id="task-对象"><a href="#task-对象" class="header-anchor">#</a> Task 对象</h2> <h3 id="asyncio-task"><a href="#asyncio-task" class="header-anchor">#</a> <code>asyncio.Task</code></h3> <p><code>class asyncio.Task(coro, *, loop=None, name=None)</code></p> <p>一个与 <a href="https://docs.python.org/zh-cn/3/library/asyncio-future.html#asyncio.Future" target="_blank" rel="noopener noreferrer"><code>Future</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 类似的对象，可运行 Python 协程。非线程安全。</p> <p>Task 对象被用来在事件循环中运行协程。如果一个协程在等待一个 Future 对象，Task 对象会挂起该协程的执行并等待该 Future 对象完成。当该 Future 对象 <em>完成</em>，被打包的协程将恢复执行。</p> <p>事件循环使用协同日程调度: 一个事件循环每次运行一个 Task 对象。而一个 Task 对象会等待一个 Future 对象完成，该事件循环会运行其他 Task、回调或执行 IO 操作。</p> <p>使用高层级的 <code>asyncio.create_task()</code>函数来创建 Task 对象，也可用低层级的 <code>loop.create_task()</code>或 <code>ensure_future()</code>函数。不建议手动实例化 Task 对象。</p> <p>要取消一个正在运行的 Task 对象可使用 <code>cancel()</code>方法。调用此方法将使该 Task 对象抛出一个 <code>CancelledError</code>异常给打包的协程。如果取消期间一个协程正在等待一个 Future 对象，该 Future 对象也将被取消。</p> <p><code>cancelled()</code>可被用来检测 Task 对象是否被取消。如果打包的协程没有抑制 <code>CancelledError</code>异常并且确实被取消，该方法将返回 <code>True</code>。</p> <p><code>asyncio.Task</code>从 <code>Future</code>继承了其除 <code>Future.set_result()</code>和 <code>Future.set_exception()</code>以外的所有 API。</p> <p>Task 对象支持 <a href="https://docs.python.org/zh-cn/3/library/contextvars.html#module-contextvars" target="_blank" rel="noopener noreferrer"><code>contextvars</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 模块。当一个 Task 对象被创建，它将复制当前上下文，然后在复制的上下文中运行其协程。</p> <p><em>在 3.7 版更改:</em> 加入对 <code>contextvars</code>模块的支持。</p> <p><em>在 3.8 版更改:</em> 添加了 <code>name</code> 形参。</p> <ul><li><p><code>cancel</code>(<em>msg=None</em>)</p> <p>请求取消 Task 对象。这将安排在下一轮事件循环中抛出一个 <a href="https://docs.python.org/zh-cn/3/library/asyncio-exceptions.html#asyncio.CancelledError" target="_blank" rel="noopener noreferrer"><code>CancelledError</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 异常给被封包的协程。协程在之后有机会进行清理甚至使用 <code>try</code> ... ... <code>except CancelledError</code> ... <code>finally</code> 代码块抑制异常来拒绝请求。不同于 <code>Future.cancel()</code>，<code>Task.cancel()</code>不保证 Task 会被取消，虽然抑制完全取消并不常见，也很不鼓励这样做。<em>在 3.9 版更改:</em> 增加了 <code>msg</code> 形参。以下示例演示了协程是如何侦听取消请求的:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">cancel_me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'cancel_me(): before sleep'</span><span class="token punctuation">)</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># Wait for 1 hour</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3600</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> asyncio<span class="token punctuation">.</span>CancelledError<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'cancel_me(): cancel sleep'</span><span class="token punctuation">)</span>
        <span class="token keyword">raise</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'cancel_me(): after sleep'</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Create a &quot;cancel_me&quot; Task</span>
    task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>cancel_me<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># Wait for 1 second</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    task<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> task
    <span class="token keyword">except</span> asyncio<span class="token punctuation">.</span>CancelledError<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;main(): cancel_me is cancelled now&quot;</span><span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># Expected output:</span>
<span class="token comment">#</span>
<span class="token comment">#     cancel_me(): before sleep</span>
<span class="token comment">#     cancel_me(): cancel sleep</span>
<span class="token comment">#     cancel_me(): after sleep</span>
<span class="token comment">#     main(): cancel_me is cancelled now</span>
</code></pre></div></li> <li><p><code>cancelled</code>()</p> <p>如果 Task 对象 被取消 则返回 True。</p> <p>当使用 <code>cancel()</code>发出取消请求时 Task 会被 取消，其封包的协程将传播被抛入的 <code>CancelledError</code>异常。</p></li> <li><p><code>done</code>()</p> <p>如果 Task 对象 <em>已完成</em> 则返回 <code>True</code>。</p> <p>当 Task 所封包的协程返回一个值、引发一个异常或 Task 本身被取消时，则会被认为 <em>已完成</em>。</p></li> <li><p><code>result</code>()</p> <p>返回 Task 的结果。</p> <p>如果 Task 对象 已完成，其封包的协程的结果会被返回 (或者当协程引发异常时，该异常会被重新引发)。</p> <p>如果 Task 对象 被取消，此方法会引发一个<code>CancelledError</code> 异常。</p> <p>如果 Task 对象的结果还不可用，此方法会引发一个<code>InvalidStateError</code> 异常。</p></li> <li><p><code>exception</code>()</p> <p>返回 Task 对象的异常。</p> <p>如果所封包的协程引发了一个异常，该异常将被返回。如果所封包的协程正常返回则该方法将返回 None。</p> <p>如果 Task 对象 被取消，此方法会引发一个 <code>CancelledError</code>异常。</p> <p>如果 Task 对象尚未 完成，此方法将引发一个<code>InvalidStateError</code> 异常。</p></li> <li><p><code>add_done_callback</code>(<em>callback</em>, ***, <em>context=None</em>)</p> <p>添加一个回调，将在 Task 对象 完成 时被运行。</p> <p>此方法应该仅在低层级的基于回调的代码中使用。</p></li> <li><p><code>remove_done_callback</code>(<em>callback</em>)</p> <p>从回调列表中移除 callback 指定的回调。</p> <p>此方法应该仅在低层级的基于回调的代码中使用。</p></li> <li><p><code>get_stack</code>(***, <em>limit=None</em>)</p> <p>返回此 Task 对象的栈框架列表。</p> <p>如果所封包的协程未完成，这将返回其挂起所在的栈。如果协程已成功完成或被取消，这将返回一个空列表。如果协程被一个异常终止，这将返回回溯框架列表。</p> <p>框架总是从按从旧到新排序。</p> <p>每个被挂起的协程只返回一个栈框架。</p> <p>可选的 limit 参数指定返回框架的数量上限；默认返回所有框架。返回列表的顺序要看是返回一个栈还是一个回溯：栈返回最新的框架，回溯返回最旧的框架。(这与 traceback 模块的行为保持一致。)</p></li> <li><p><code>print_stack</code>(***, <em>limit=None</em>, <em>file=None</em>)</p> <p>打印此 Task 对象的栈或回溯。</p> <p>此方法产生的输出类似于<code>traceback</code> 模块通过 <code>get_stack()</code>所获取的框架。</p> <p>limit 参数会直接传递给<code>get_stack()</code>。</p> <p>file 参数是输出所写入的 I/O 流；默认情况下输出会写入<code>sys.stderr</code></p></li> <li><p><code>get_coro</code>()</p> <p>返回由 <code>Task</code>包装的协程对象。</p> <p><em>3.8 新版功能.</em></p></li> <li><p><code>get_name</code>()</p> <p>返回 Task 的名称。</p> <p>如果没有一个 Task 名称被显式地赋值，默认的 asyncio Task 实现会在实例化期间生成一个默认名称。</p> <p><em>3.8 新版功能.</em></p></li> <li><p><code>set_name</code>(<em>value</em>)</p> <p>设置 Task 的名称。</p> <p><em>value</em> 参数可以为任意对象，它随后会被转换为字符串。</p> <p>在默认的 Task 实现中，名称将在任务对象的 <a href="https://docs.python.org/zh-cn/3/library/functions.html#repr" target="_blank" rel="noopener noreferrer"><code>repr()</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 输出中可见</p> <p>。<em>3.8 新版功能.</em></p></li></ul> <h2 id="基于生成器的协程"><a href="#基于生成器的协程" class="header-anchor">#</a> 基于生成器的协程</h2> <blockquote><p>注解：对基于生成器的协程的支持 <strong>已弃用</strong> 并计划在 Python 3.10 中移除。</p></blockquote> <p>基于生成器的协程是 async/await 语法的前身。它们是使用 <code>yield from</code> 语句创建的 Python 生成器，可以等待 Future 和其他协程。</p> <p>基于生成器的协程应该使用 <a href="https://docs.python.org/zh-cn/3/library/asyncio-task.html#asyncio.coroutine" target="_blank" rel="noopener noreferrer"><code>@asyncio.coroutine</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 装饰，虽然这并非强制。</p> <ul><li><p><code>@asyncio.coroutine</code></p> <p>用来标记基于生成器的协程的装饰器。此装饰器使得旧式的基于生成器的协程能与 async/await 代码相兼容:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token decorator annotation punctuation">@asyncio<span class="token punctuation">.</span>coroutine</span>
<span class="token keyword">def</span> <span class="token function">old_style_coroutine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">yield</span> <span class="token keyword">from</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> old_style_coroutine<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p><code>asyncio.iscoroutine</code>(<em>obj</em>)</p> <p>如果 <em>obj</em> 是一个 协程对象则返回 <code>True</code>。此方法不同于 <code>inspect.iscoroutine()</code>因为它对基于生成器的协程返回 <code>True</code>。</p></li> <li><p><code>asyncio.iscoroutinefunction</code>(<em>func</em>)</p> <p>如果 <em>func</em> 是一个 协程函数则返回 <code>True</code>。此方法不同于 <code>inspect.iscoroutinefunction()</code>因为它对以 <code>@coroutine</code>装饰的基于生成器的协程函数返回 <code>True</code>。</p></li></ul></div> <!----> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/python/coroutine/" class="prev router-link-active">
        asyncio --- 异步 I/O
      </a></span> <span class="next"><a href="/python/coroutine/同步原语.html">
        同步原语
      </a>
      →
    </span></p></div> <div class="page-footer"><ul class="inner"><li>Theme by <a href="https://github.com/qcyblm/vuepress-theme-vpx" title="本站主题" target="_blank" rel="noopener noreferrer">VPX</a></li> <li>Powered by <a href="https://www.vuepress.cn/" target="_blank" rel="noopener noreferrer">VuePress</a></li> <!----> <li>
      © 2018-2021
      <a href="https://xuqilong.top" target="_blank" rel="noopener noreferrer"> Copyright © 2021-present Qilong Xu © 2019 </a></li> <li><a href="https://beian.miit.gov.cn" target="_blank" rel="noopener noreferrer"><!---->  粤ICP备19034953号-1
      </a></li> </ul></div> </main> <!----></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.b8069efc.js" defer></script><script src="/assets/js/2.463f0d24.js" defer></script><script src="/assets/js/18.f5401d4b.js" defer></script>
  </body>
</html>
